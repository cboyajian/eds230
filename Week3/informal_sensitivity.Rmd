---
title: "Informal Sensitivity"
author: "Clarissa"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

source("solarpv.R")
```

# load data

```{r}
load("../Data/sierraczosolar.rda")
```

```{r}
# already in the format required for the model
head(sierraczosolar)

# run the model
solarpv(area = 0.1, solar = sierraczosolar, 
        clr = "green", eunit = "W")
```

## informal sensitivity analysis

```{r}
# use map from purrr
# notice how map adds the one parameter that is missing from the input list
solar_radiation = rnorm(mean = 10000, sd = 100, n = 20)
site2 = solar_radiation %>% map(~solarpv(area = 0.1, solar = sierraczosolar, 
                     clr = "green", eunit = "W", g = FALSE, 
                     etype = "direct", ethresh = .x))

head(site2)

# this is pretty messy - but we can extract a useful data structure,lets say we want 
# just the annual data (not the mean annual time series), and then reformat as a data frame with nice column names
tmp = map_df(site2,`[`, c("annual")) 

site2df = data.frame(year = tmp$annual$year, 
                     elect = tmp$annual$elect)

# now we could plot
ggplot(site2df, 
       aes(y = year, x = elect, group = year )) + 
  geom_boxplot() + 
  labs(y = "Electricity generated in W")

# we also might want an average across parameter uncertainty
site2_average = site2df %>% 
  group_by(year) %>% 
  summarize(elect = mean(elect))

# now add this to the plot - note that we remove the grouping by using group=1
ggplot(site2df, 
       aes(x = year, y = elect, group = year)) +
  geom_boxplot() +
  labs(y = "Electricity in W")+
  geom_line(data = site2_average, 
            aes(year, elect, group = 1), 
            col="orange")

# we could also plot how the mean annual electricity varies with efficiency (eff from above)
site2[[1]]

tmp = map_df(site2,`[`, c("mean")) 

# how variable is electricity generation (mean over all time) with uncertainty in solar efficiency

site2_mean = data.frame(solar_radiation = solar_radiation, 
                        elect = tmp)
ggplot(site2_mean, 
       aes(y = mean)) +
  geom_boxplot() +
  labs(x = "Electricity in W")

# or to see what the sensitivity looks like
ggplot(site2_mean, 
       aes(x = solar_radiation, y = mean)) + 
  geom_point() +
  labs(y = "Electricity in W", 
       x = "Solar Radioation")
```




